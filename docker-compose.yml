# Docker Compose for Azkaban (Authentication Service)
# Standalone configuration - independent repository
#
# NOTE: Database (PostgreSQL) is managed in ministry/docker-compose.yml
# This service connects to the database service from ministry

services:
  # Azkaban API
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: azkaban-api
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-local}
      # Firebase credentials are loaded from service-account.json file if available
      # For local development, you can either:
      # 1. Place service-account.json in the project root (recommended)
      # 2. Or use FIREBASE_CREDENTIALS env var with the full JSON
      FIREBASE_CREDENTIALS: ${FIREBASE_CREDENTIALS:-}
      # Connect to database from ministry docker-compose network
      # For local development without Docker: use localhost:5433
      DATABASE_URL: ${DATABASE_URL:-postgresql://azkaban:azkaban_dev@azkaban-db:5432/azkaban_db}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@littio.co}
      FIXED_OTP_CODE: ${FIXED_OTP_CODE:-123456}
      CASSANDRA_API_URL: ${CASSANDRA_API_URL:-http://host.docker.internal:3000}
      CASSANDRA_API_KEY: ${CASSANDRA_API_KEY:-}
    ports:
      - "8001:8000"
    networks:
      - ministry_default
    volumes:
      - .:/app
      # Mount service-account.json if it exists locally
      - ./service-account.json:/app/service-account.json:ro
    command: uvicorn handler:app --host 0.0.0.0 --port 8000 --reload

networks:
  ministry_default:
    external: true

