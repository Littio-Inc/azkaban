service: azkaban
frameworkVersion: '3'

useDotenv: true

custom:
  serverless-offline:
    noPrependStageInUrl: true
  pythonRequirements:
    usePipenv: true
    zip: true

provider:
  name: aws
  runtime: python3.11
  timeout: 30
  stage: ${opt:stage, "staging"}
  region: ${env:AWS_DEFAULT_REGION}
  vpc:
    securityGroupIds:
      - ${env:VPC_SECURITY_GROUP_ID}
    subnetIds:
      - ${env:SUBNET_ID_ONE}
      - ${env:SUBNET_ID_TWO}
  iam:
    role:
      statements:
        - Effect: 'Allow'
          Action: 'secretsmanager:GetSecretValue'
          Resource: ${env:SECRET_MANAGER_AZKABAN_ARN}
  environment:
    ENVIRONMENT: ${env:ENVIRONMENT}
    DATABASE_URL: ${env:DATABASE_URL}
    SECRET_MANAGER_AZKABAN_ARN: ${env:SECRET_MANAGER_AZKABAN_ARN}
    CORS_ALLOWED_ORIGINS: ${env:CORS_ALLOWED_ORIGINS, ""}
    BASILISCO_API_KEY: ${env:BASILISCO_API_KEY}
    BASILISCO_BASE_URL: ${env:BASILISCO_BASE_URL}
    DIAGON_API_KEY: ${env:DIAGON_API_KEY}
    DIAGON_BASE_URL: ${env:DIAGON_BASE_URL}
  httpApi:
    cors:
      allowedOrigins:
        # For staging/local: allow localhost + configured origins
        # For production: only configured origins
        # Only add CORS_ALLOWED_ORIGINS if it's not empty
        # Use "*" as fallback if CORS_ALLOWED_ORIGINS is not set or empty
        - ${env:CORS_ALLOWED_ORIGINS, "*"}
        # Always add localhost origins for staging/local (will be filtered in production if needed)
        - http://localhost:4321
        - http://localhost:3000
        - http://127.0.0.1:4321
        - http://127.0.0.1:3000
      allowedHeaders:
        - "*"
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      allowCredentials: true
      maxAge: 86400
    authorizers:
      azkaban-authorizer:
        type: request
        enableSimpleResponses: true
        functionName: api-gateway-authorizer
        resultTtlInSeconds: 300  # Cache for 5 minutes
        identitySource:
          - $request.header.Authorization
  logs:
    httpApi:
      format: '{"requestTime":"$context.requestTime","requestId":"$context.requestId","httpMethod":"$context.httpMethod","path":"$context.path","routeKey":"$context.routeKey","status":$context.status,"responseLatency":$context.responseLatency}'

package:
  individually: true
  patterns:
    - '.env'
    - 'service-account.json'
    - 'firebase_service_account.json'
    - '!app/**/test_*.py'
    - '!node_modules/**/*.md'
    - '!node_modules/**/*.flow'
    - '!node_modules/**/*.patch'
    - '!node_modules/**/*.conf'
    - '!node_modules/**/*.markdown'
    - '!node_modules/**/*.coffee'
    - '!node_modules/**/jsdoc_conf.json'
    - '!node_modules/**/*Makefile'
    - '!node_modules/**/Dockerfile'
    - '!node_modules/**/*.txt'
    - '!node_modules/**/*.yml'
    - '!node_modules/**/*.xml'
    - '!node_modules/**/*.html'
    - '!node_modules/**/test/**'
    - '!node_modules/**/tests/**'
    - '!node_modules/**/examples/**'
    - '!node_modules/**/coverage/**'
    - '!node_modules/**/.nyc_output/**'
    - '!node_modules/**/bin/**'
    - '!node_modules/**/bower.json'
    - '!node_modules/**/karma.conf.js'
    - '!node_modules/**/Gruntfile.js'
    - '!node_modules/**/rollup.config.*'
    - '!node_modules/**/yarn.lock'
    - '!node_modules/**/sonar-project.properties'
    - '!node_modules/**/package-lock.json'
    - '!node_modules/**/*.d.ts'
    - '!node_modules/**/*.map'
    - '!node_modules/**/tsconfig.json'
    - '!node_modules/**/AUTHORS'
    - '!node_modules/**/CODEOWNERS'
    - '!node_modules/**/OWNERS'
    - '!node_modules/**/*.iml'
    - '!node_module/**/*.bash_completion.in'
    - '!node_modules/**/*.gif'
    - '!node_modules/**/*.png'
    - '!node_modules/**/*.jpg'
    - '!node_modules/**/*.jpeg'
    - '!node_modules/**/winston/scratch/**'
    - '!node_modules/**/sshpk/man/**'
    - '!node_modules/**/bluebird/js/browser/**'
    - '!node_modules/**/date-fns/docs.json'
    - '!node_modules/**/aws-xray-sdk-core/doc-src/**'
    - '!node_modules/**/aws-sdk/dist/**'
    - '!node_modules/**/aws-sdk/dist-tools/**'

plugins:
  - serverless-python-requirements
  - serverless-offline

functions:
  # API Gateway Authorizer - Verifies Firebase tokens
  api-gateway-authorizer:
    handler: handler.lambda_authorizer_handler #app.authorizers.api_gateway_authorizer.lambda_authorizer_handler
    timeout: 5

  # Main API endpoints - All routes handled by FastAPI
  http-api:
    handler: handler.http_handler
    timeout: 30
    events:
      - httpApi:
          method: ANY
          path: /v1/{proxy+}
          authorizer: azkaban-authorizer
      - httpApi:
          method: OPTIONS
          path: /v1/{proxy+}
      - httpApi:
          method: GET
          path: /v1/backoffice/transactions
          authorizer: azkaban-authorizer
      - httpApi:
          method: GET
          path: /v1/vault/accounts
          authorizer: azkaban-authorizer
      - httpApi:
          method: get
          path: /health
      - httpApi:
          method: head
          path: /health

